<div align="center">
    <h1>第十四届全国海洋航行器设计与制作大赛
    <h2>F1帆船模型竞速 - 现代帆船竞速
</div>

## 一、项目简介
本项目为 “第十四届全国海洋航行器设计与制作大赛 - F1帆船模型竞速” 的软件控制部分，使用 **STM32F103C8T6** 微控制器实现红外数据采集、舵机角度控制与通信调试，完成自动控制路径跟踪功能。

## 二、项目主体结构
 User/  
 ├── main.c // 主函数入口  
 │  
 ├── GPIO // GPIO初始化，包含红外、PWM引脚配置  
 │  ├──  GPIO.h  
 │  └──  GPIO.c  
 │  
 ├── Usart1 // 串口USART1初始化及发送函数  
 │  ├──  usart1.h  
 │  └──  usart1.c  
 │  
 ├── pwm // TIM1、TIM3用于PWM输出控制舵机  
 │  ├──  pwm.h  
 │  └──  pwm.c  
 │  
 ├── Timer1 // TIM1定时中断，每67ms触发一次数据处理与舵机控制  
 │  ├──  Timer1.h  
 │  └──  Timer1.c  

## 三、系统功能
### 1. 功能概述
| 模块     | 功能描述 |
|----------|----------|
| GPIO     | 配置红外接收输入、PWM输出及串口通信引脚 |
| PWM      | 通过 TIM1（PA8）和 TIM3（PA7）输出 PWM 控制信号 |
| Timer1   | 配置 TIM1 每 67ms 触发一次中断，用于红外信号处理与舵机角度计算 |
| USART1   | 初始化串口 9600 波特率，支持 `printf` 重定向，便于蓝牙或串口调试 |
| 主逻辑   | 实时读取 15 路红外传感器数据，识别红外信号区域，计算舵机角度，并输出控制信号 |

### 2. 硬件引脚连接
| 模块        | 引脚      | 说明                     |
|-------------|-----------|--------------------------|
| PWM输出1    | PA8       | TIM1_CH1 控制主舵机角度 |
| PWM输出2    | PA7       | TIM3_CH2 预留控制第二通道 |
| USART1 TX   | PA9       | 串口发送（连接蓝牙模块） |
| USART1 RX   | PA10      | 串口接收                 |
| 红外接收    | PB3~PB5、PB10~PB15、PC6~PC7、PC10~PC12、PD2、PA15 | 共15路红外输入信号 |
> 注：通过关闭JTAG释放PB3~PB5端口用于红外输入。

### 3. 控制核心算法
- **红外采样逻辑**：主循环中不断采样 15 路红外接收器状态，累加在 `irm_data[i][0]` 中，并设置对应 `irm_flag[i] = 1`
- **定时处理**：TIM1中断每67ms触发一次，完成以下任务：
  1. 分类红外区域（左/中/右）信号强度
  2. 丢信号检测与上次角度保持处理
  3. 寻找信号连续的最大块，计算其重心位置作为角度输入
  4. 输出 PWM 控制信号至舵机（角度范围 900 ~ 2100）
- **调试信息**：当开启 `bluetoothsend = 1` 时，通过串口输出传感器数据、角度值、PWM控制量等调试信息。

### 4. PWM控制公式

```c {linenumber}
angle_pwm = 1500 + (int)((angle - 8) * 200) + (angle - anglelast) * 40;
```
> 注：angle_pwm 限制在 [900, 2100] 范围内

### 5. 使用方法
1.	使用 STM32 烧录工具（如 ST-Link）将代码烧写至 STM32F103C8T6
2.	接线对应如上引脚表，连接红外、舵机、蓝牙模块
3.	使用串口助手（如 CoolTerm）连接串口（9600 波特率）
4.	启动后将持续输出舵机控制信号，可根据调试信息进行算法优化

### 6. 关键参数说明
| 参数 | 默认值 | 说明 |
|-------------|-----------|--------------------------|
| TIM1周期 | 674 | 对应约 67ms 中断周期 |
| PWM 主舵机通道 | TIM1_CH1 / PA8 | 控制主向偏转角 |
| 中心角度基准 | 1500 | 舵机中位值 |
| 红外采样窗口 | 15通道 | 从IRM1 ~ IRM15并行处理 |